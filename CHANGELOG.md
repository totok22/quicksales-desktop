# 更新日志

## 2026-02-15（性能优化第一批）

### 优化内容
1. **页面级懒加载与分包**
   - 主视图页面改为按需加载，减少首屏主包体积。
   - 在主内容区加入 `Suspense` 轻量加载态，切换页面体验更平滑。

2. **高频搜索防抖**
   - 商品管理、客户管理、订单历史搜索统一加入 200ms 防抖，降低每次按键触发的大量过滤计算。

3. **分类统计计算优化**
   - 商品管理中分类计数改为预计算映射（直接计数 + 递归汇总），减少渲染期重复 `filter` 扫描。

### 构建结果
- 构建通过：`npm run build`
- 分包后主入口 `index` 显著下降（约 244KB），页面块独立输出。
- 当前最大块为 `excelService`（约 946KB），后续可继续拆分导出相关依赖。

### 涉及文件
- `src/App.tsx`
- `src/pages/ProductManagement.tsx`
- `src/pages/CustomerManagement.tsx`
- `src/pages/OrderHistory.tsx`

## 2026-02-15（统计图布局修正与性能评估）

### 修复问题
1. **销售日趋势图纵向留白过大、横坐标位置异常**
   - 将趋势图改为“图形区 + 独立横坐标区”两段布局，横坐标固定在图底部，不再出现在图中部。
   - 柱体改为像素高度计算，避免百分比高度在容器/滚动布局下导致显示异常。
   - 无数据日显示细底线，避免“整块空白”的错觉。

### 验证
- 前端构建通过：`npm run build`

### 涉及文件
- `src/pages/SalesStatistics.tsx`

## 2026-02-15（统计与分类管理修复）

### 修复问题
1. **销售统计“销售日趋势”空白/显示异常**
   - 修复订单日期比较使用字符串导致的时区偏移问题，统一按本地日期（`YYYY-MM-DD`）进行过滤与聚合。
   - 修复趋势图在有数据时柱体过淡导致“看起来像空白”的问题，提升柱体对比度与最小高度。
   - 优化活跃客户统计口径，改为“筛选期实际活跃客户数”，不再错误显示 Top5 长度。

2. **商品管理分类/子分类显示与筛选逻辑**
   - 分类数据统一按 `sortOrder`（同序再按名称）稳定排序，避免顺序混乱。
   - 分类筛选支持“父分类包含子分类商品”，与实际业务认知一致。
   - 商品列表/批量修改分类/编辑商品下拉中统一显示“分类路径”（如 `保养 / 机油`），解决子分类可读性问题。
   - 分类侧栏补充子分类可视列表与点击筛选，完善父子层级展示。
   - 根分类拖拽和上下移动改为仅重排同层根分类，避免影响子分类顺序，修复“看起来可拖但排序异常”的问题。

### 验证
- 前端构建通过：`npm run build`

### 涉及文件
- `src/pages/SalesStatistics.tsx`
- `src/pages/ProductManagement.tsx`

## 2026-02-15（稳定性修复）

### 修复问题
1. **新建订单默认模板丢失**
   - 修复了切换“新建订单”标签后模板回退为“请选择模板”的问题。
   - 新增“解析后的默认模板”逻辑：优先使用已保存默认模板，其次回退模板列表默认项，再回退首个模板。
   - 修复了草稿模板ID未初始化导致导出时报“请先在设置中配置Excel模板!”的问题。

2. **导出行为设置保存后丢失**
   - 修复“跳过保存对话框/导出后自动打开Excel/文件命名模式”在切换页面后恢复默认的问题。
   - 根因是后端 `AppSettings` 模型与数据库表缺失对应字段，导致前端保存后读写丢失。
   - 已补齐后端模型字段、数据库建表字段、旧库升级 `ALTER TABLE` 以及读写 SQL。

3. **订单页刷新与序号逻辑不一致**
   - 修复订单页“刷新”仅刷新客户而不刷新商品（库存不更新）的行为，改为同时刷新客户与商品。
   - 修复日期/模板切换后草稿未同步，导致保存上下文不一致的问题。
   - 优化订单号逻辑：当订单号格式包含 `{SEQ}` 时，日期/模板变化会清空草稿订单号，确保保存时重新生成正确序号；手动固定格式则不清空。

### 涉及文件
- `src/pages/OrderEntry.tsx`
- `src/stores/useStore.ts`
- `src-tauri/src/models/mod.rs`
- `src-tauri/src/database/connection.rs`
- `src-tauri/src/database/schema.rs`
- `src-tauri/src/commands/order_commands.rs`

## 2026-02-15（客户与搜索体验修复）

### 修复问题
1. **客户去重规则增强**
   - 调整客户识别逻辑：姓名 / 电话 / 车牌号任一完全相同即视为同一客户。
   - 新增后端按身份字段匹配方法，保存客户时自动合并到已存在客户记录，避免重复客户。

2. **拼音搜索更智能（接近微信搜索）**
   - 拼音码从“仅首字母”升级为“首字母 + 全拼”联合索引。
   - 支持 `wang`、`wcy`、`w`、`wan` 等前缀/片段命中。
   - 订单页商品选择与商品管理页搜索都统一使用增强规则。

3. **新建订单右上角刷新行为可见化**
   - 刷新动作明确为“同时刷新客户和商品（含库存）”。
   - 增加刷新中状态与最近刷新时间显示，避免“点击后没变化”的感知问题。

4. **图标更换说明补充**
   - 在 README 增加 Tauri 图标替换和重生成步骤（`npm run tauri icon`）。

### 涉及文件
- `src-tauri/src/database/schema.rs`
- `src-tauri/src/commands/customer_commands.rs`
- `src-tauri/src/commands/product_commands.rs`
- `src/components/order/ProductSelection.tsx`
- `src/pages/ProductManagement.tsx`
- `src/pages/OrderEntry.tsx`
- `README.md`

## 2026-02-15（订单与客户数据一致性修复）

### 修复问题
1. **客户去重规则回调修正**
   - 移除“姓名去重”，仅保留“电话/车牌号去重”，避免同名误合并。

2. **临时客户不再出现在客户管理**
   - 临时客户保存订单时改为写入“订单专用快照客户ID（order_customer_*）”，不污染客户管理列表。
   - 客户查询默认过滤 `temp_*` / `order_customer_*` / `deleted_*` 记录。

3. **删除客户不再丢失历史订单**
   - 删除前自动把历史订单重定向到“已删除客户（历史保留）”占位客户，再删除原客户。

4. **客户管理新增手动合并**
   - 新增“手动合并客户”弹窗与后端命令，支持把源客户历史订单转移到目标客户。

5. **订单页刷新补充拼音刷新**
   - 新建订单页刷新时会先执行商品拼音码批量刷新，再刷新客户与商品数据。

6. **统计页空数据修复**
   - 统计页在本地无订单缓存时会自动调用后端加载订单。

7. **订单历史导入导出（JSON）**
   - 新增订单历史 JSON 导入/导出能力，并在页面显示导入格式说明。

### 涉及文件
- `src-tauri/src/commands/customer_commands.rs`
- `src-tauri/src/database/schema.rs`
- `src-tauri/src/commands/order_commands.rs`
- `src-tauri/src/lib.rs`
- `src/pages/CustomerManagement.tsx`
- `src/pages/OrderEntry.tsx`
- `src/pages/SalesStatistics.tsx`
- `src/pages/OrderHistory.tsx`
- `README.md`

## 2026-02-15

### 新增功能
1. **Excel导出设置优化**
   - 新增"跳过保存对话框"选项：启用后直接保存到默认输出目录，无需每次选择保存位置
   - 新增"导出后自动打开Excel"选项：启用后Excel文件导出成功将自动打开，无需手动确认

### 修复问题
1. **修复文件打开权限问题**
   - 修复了安装MSI后打开Excel文件时报错"Not allowed to open path"的问题
   - 更新了Tauri权限配置，允许打开任意路径的文件

### 使用说明
- 进入"系统设置" → "Excel导出设置"
- 勾选"跳过保存对话框"：点击"保存并导出"时将直接保存到"Excel输出目录"
- 勾选"导出后自动打开Excel"：导出成功后自动打开Excel文件
- 建议同时启用这两个选项以获得最佳体验

### 技术细节
- 修改文件：
  - `src/types/index.ts` - 添加新的设置字段
  - `src/services/excelService.ts` - 支持跳过保存对话框
  - `src/pages/OrderEntry.tsx` - 根据设置自动打开文件
  - `src/pages/Settings.tsx` - 添加新的设置选项
  - `src-tauri/capabilities/default.json` - 修复文件打开权限
# 2026-02-15

## 分析与修复（统计页面 + 设置项核查）

### 1) 设置项核查：`dataDirectory` 当前状态

- 已确认 [`Settings.tsx`](desktop-version/src/pages/Settings.tsx) 中“数据存储目录”会被保存到数据库字段 `app_settings.data_directory`。
- 但后端数据库初始化路径仍固定使用 [`lib.rs`](desktop-version/src-tauri/src/lib.rs) 的 `app_data_dir/quicksales.db`，未读取 `data_directory`。
- 结论：该设置目前属于“可保存但未生效”的预留项，不影响现有功能，但会造成用户理解偏差。

### 2) 统计页面问题修复与优化

已在 [`SalesStatistics.tsx`](desktop-version/src/pages/SalesStatistics.tsx) 完成如下优化：

- 修复日期解析与时区边界问题，避免 `toISOString()` 导致的跨天偏移。
- 增加“刷新数据”能力，支持主动重拉订单数据。
- 修复日期区间异常（开始晚于结束）时的容错处理与提示。
- 支持更稳健的客户/商品统计键，避免空字段导致聚合异常。
- 修复 Top 条形图在边界情况下的除零风险。
- 趋势图从固定按日升级为按区间自适应：按日 / 按周 / 按月。
- 优化趋势图标签与 tooltip 展示，提升可读性。

### 3) 验证结果

- 执行 `npm run build`（desktop-version）通过。
- 无 TypeScript 编译错误。
- 保留现有业务接口与数据结构兼容性。

## 统计页面二次深度优化（按反馈完善）

基于“统计维度不足、筛选不够、趋势交互细节不达标”的反馈，对 [`SalesStatistics.tsx`](desktop-version/src/pages/SalesStatistics.tsx) 进行了重构增强：

### 信息架构升级

- KPI 从基础 4 项扩展为 6 项：销售额、订单数、客单价、活跃客户、商品总件数、商品种类数。
- 新增环比视角：销售额环比、订单数环比（与上一等长周期比较）。
- 新增“分类贡献 Top 8”“核心客户 Top 8”“畅销商品 Top 8”。
- 新增“订单明细（当前筛选）”区域，支持快速核对统计来源。

### 筛选能力补强

- 快速时间范围：近7天 / 近30天 / 近90天 / 近1年 / 自定义。
- 多维筛选：客户关键字（姓名/车牌/电话）、商品关键字、分类、客户类型（新客户/复购客户）、订单金额区间。
- 增加筛选容错：日期区间和金额区间异常时有明确提示。

### 趋势图交互优化

- 维持按区间自适应粒度（日/周/月）。
- 鼠标悬浮时在图上方固定信息条实时显示金额和单量。
- 同时给柱子增加浏览器原生 `title`，避免“悬浮看不到金额”的问题。
- 空数据态与异常态统一处理。

### 数据导出

- 新增“导出明细”：将当前筛选结果导出为 CSV（含 BOM，兼容 Excel 打开中文）。

### 验证

- 再次执行 `npm run build` 通过。

## 统计筛选交互补充（客户/商品下拉多选）

根据反馈“客户/商品搜索缺少可确认列表与多选能力”，在 [`SalesStatistics.tsx`](desktop-version/src/pages/SalesStatistics.tsx) 追加：

- 客户筛选新增下拉多选面板（支持勾选、取消、清空已选）。
- 商品筛选新增下拉多选面板（支持勾选、取消、清空已选）。
- 下拉列表与关键字输入联动：输入关键字可缩小候选范围，再进行多选确认。
- 多选条件与原关键字筛选逻辑并行生效（兼容原有行为，不破坏旧筛选）。

验证：`npm run build` 通过。
